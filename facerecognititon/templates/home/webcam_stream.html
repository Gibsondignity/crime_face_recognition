{% extends "layout/base.html" %}
{% load static %}
{% block main_content %}

<div class="px-6 py-8 bg-gray-100 min-h-screen animate-fade-in">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="bg-green-100 text-green-700 p-4 rounded shadow">
          {{ message|safe }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Real-Time Criminal Detection</h2>

  <div class="max-w-6xl mx-auto">
    <!-- Main Video Feed -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
      <div class="p-6">
        <div class="relative bg-black rounded-lg overflow-hidden" style="height: 480px;">
          <img id="videoFeed" 
               src="{% url 'video_feed' %}" 
               alt="Video Feed" 
               class="w-full h-full object-contain"
               style="max-width: 100%; max-height: 100%;">
          
          <!-- Loading overlay -->
          <div id="loadingOverlay" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            <div class="text-center text-white">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
              <p>Initializing camera...</p>
            </div>
          </div>
        </div>
        
        <!-- Camera Status -->
        <div class="flex items-center justify-between mt-4">
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div id="statusIndicator" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
              <span id="statusText" class="text-gray-600 font-medium">Connecting...</span>
            </div>
            <div class="text-sm text-gray-500">
              <span id="detectionCount">0</span> detections
            </div>
          </div>
          
          <div class="flex space-x-3">
            <button id="pauseBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition">
              <i class="fas fa-pause mr-1"></i> Pause
            </button>
            <button id="resumeBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition hidden">
              <i class="fas fa-play mr-1"></i> Resume
            </button>
            <a href="{% url 'stop_webcam' %}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition">
              <i class="fas fa-stop mr-1"></i> Stop Camera
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Detection Results Panel -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Recent Detections -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-eye text-blue-500 mr-2"></i>Recent Detections
          </h3>
          <div id="detectionList" class="space-y-3 max-h-96 overflow-y-auto">
            <div class="text-gray-500 text-center py-4">
              <i class="fas fa-search text-3xl mb-2"></i>
              <p>No detections yet...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- System Information -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-info-circle text-green-500 mr-2"></i>System Information
          </h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Camera Resolution:</span>
              <span class="font-medium">640 x 480</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Detection Algorithm:</span>
              <span class="font-medium">InsightFace</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Similarity Threshold:</span>
              <span class="font-medium">60%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Session Duration:</span>
              <span id="sessionDuration" class="font-medium">00:00:00</span>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="mt-6 space-y-3">
            <a href="{% url 'spotted_criminal' %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition block text-center">
              <i class="fas fa-list mr-2"></i>View All Detections
            </a>
            <a href="{% url 'identify_criminal' %}" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition block text-center">
              <i class="fas fa-arrow-left mr-2"></i>Back to Main Menu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block js_content %}
<script>
let isPaused = false;
let detectionCount = 0;
let sessionStartTime = new Date();

document.addEventListener('DOMContentLoaded', function() {
    const videoFeed = document.getElementById('videoFeed');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const detectionCountEl = document.getElementById('detectionCount');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    
    // Handle video feed loading
    videoFeed.onload = function() {
        loadingOverlay.style.display = 'none';
        statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
        statusText.textContent = 'Camera Active';
    };

    videoFeed.onerror = function() {
        loadingOverlay.innerHTML = `
            <div class="text-center text-white">
                <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-400"></i>
                <p>Camera connection failed</p>
                <button onclick="location.reload()" class="mt-4 bg-red-500 hover:bg-red-600 px-4 py-2 rounded">
                    Retry Connection
                </button>
            </div>
        `;
        statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
        statusText.textContent = 'Connection Failed';
    };

    // Pause/Resume functionality
    pauseBtn.addEventListener('click', function() {
        isPaused = true;
        videoFeed.style.display = 'none';
        pauseBtn.classList.add('hidden');
        resumeBtn.classList.remove('hidden');
        statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full';
        statusText.textContent = 'Paused';
    });

    resumeBtn.addEventListener('click', function() {
        isPaused = false;
        videoFeed.style.display = 'block';
        resumeBtn.classList.add('hidden');
        pauseBtn.classList.remove('hidden');
        statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
        statusText.textContent = 'Camera Active';
    });

    // Update session duration
    setInterval(updateSessionDuration, 1000);
    
    // Simulate detection updates (in a real implementation, this would come from WebSocket)
    setInterval(checkForDetections, 5000);
});

function updateSessionDuration() {
    const now = new Date();
    const duration = Math.floor((now - sessionStartTime) / 1000);
    const hours = Math.floor(duration / 3600);
    const minutes = Math.floor((duration % 3600) / 60);
    const seconds = duration % 60;
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('sessionDuration').textContent = timeString;
}

function checkForDetections() {
    // This would normally fetch from an API endpoint
    // For now, we'll just simulate periodic updates
    fetch('/spotted_criminal')
        .then(response => response.text())
        .then(data => {
            // In a real implementation, parse the response and update the detection list
            // This is just a placeholder
        })
        .catch(error => {
            console.log('Detection check failed:', error);
        });
}

function addDetection(name, status, confidence, timestamp) {
    detectionCount++;
    document.getElementById('detectionCount').textContent = detectionCount;
    
    const detectionList = document.getElementById('detectionList');
    
    // Remove "no detections" message if it exists
    if (detectionList.querySelector('.text-gray-500')) {
        detectionList.innerHTML = '';
    }
    
    const detectionItem = document.createElement('div');
    detectionItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 border-red-500';
    detectionItem.innerHTML = `
        <div>
            <div class="font-semibold text-gray-800">${name}</div>
            <div class="text-sm text-gray-600">Status: ${status.toUpperCase()}</div>
            <div class="text-xs text-gray-500">${timestamp}</div>
        </div>
        <div class="text-right">
            <div class="text-sm font-medium ${confidence > 0.8 ? 'text-red-600' : 'text-yellow-600'}">
                ${Math.round(confidence * 100)}%
            </div>
            <div class="text-xs text-gray-500">confidence</div>
        </div>
    `;
    
    detectionList.insertBefore(detectionItem, detectionList.firstChild);
    
    // Keep only the last 10 detections
    while (detectionList.children.length > 10) {
        detectionList.removeChild(detectionList.lastChild);
    }
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Optionally pause when tab is not visible
    } else {
        // Resume when tab becomes visible
    }
});
</script>
{% endblock %}
{% extends "layout/base.html" %}
{% load static %}
{% block main_content %}

<div class="px-6 py-8 bg-gray-100 min-h-screen animate-fade-in">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="bg-green-100 text-green-700 p-4 rounded shadow">
          {{ message|safe }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Real-Time Access Control</h2>

  <div class="max-w-6xl mx-auto">
    <!-- Main Video Feed -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
      <div class="p-6">
        <div class="relative bg-black rounded-lg overflow-hidden" style="height: 480px;">
          <video id="videoElement"
                 autoplay
                 playsinline
                 muted
                 class="w-full h-full object-contain"
                 style="max-width: 100%; max-height: 100%;">
              Your browser does not support the video tag.
          </video>
          <canvas id="canvasElement"
                  class="hidden"
                  style="display: none;">
          </canvas>
          
          <!-- Loading overlay -->
          <div id="loadingOverlay" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            <div class="text-center text-white">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
              <p>Initializing camera...</p>
            </div>
          </div>
        </div>
        
        <!-- Camera Status -->
        <div class="flex items-center justify-between mt-4">
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div id="statusIndicator" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
              <span id="statusText" class="text-gray-600 font-medium">Connecting...</span>
            </div>
            <div class="text-sm text-gray-500">
              <span id="detectionCount">0</span> detections
            </div>
          </div>
          
          <div class="flex space-x-3">
            <button id="pauseBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition">
              <i class="fas fa-pause mr-1"></i> Pause
            </button>
            <button id="resumeBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition hidden">
              <i class="fas fa-play mr-1"></i> Resume
            </button>
            <a href="{% url 'stop_webcam' %}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition">
              <i class="fas fa-stop mr-1"></i> Stop Camera
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Detection Results Panel -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Recent Detections -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-eye text-blue-500 mr-2"></i>Recent Detections
          </h3>
          <div id="detectionList" class="space-y-3 max-h-96 overflow-y-auto">
            <div class="text-gray-500 text-center py-4">
              <i class="fas fa-search text-3xl mb-2"></i>
              <p>No detections yet...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- System Information -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-info-circle text-green-500 mr-2"></i>System Information
          </h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Camera Resolution:</span>
              <span class="font-medium">640 x 480</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Detection Algorithm:</span>
              <span class="font-medium">InsightFace</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Similarity Threshold:</span>
              <span class="font-medium">60%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Session Duration:</span>
              <span id="sessionDuration" class="font-medium">00:00:00</span>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="mt-6 space-y-3">
            <a href="{% url 'spotted_unauthorized' %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition block text-center">
              <i class="fas fa-list mr-2"></i>View All Detections
            </a>
            <a href="{% url 'detect_unauthorized' %}" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition block text-center">
              <i class="fas fa-arrow-left mr-2"></i>Back to Main Menu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block js_content %}
<script>
// Browser-based camera access
let stream = null;
let isProcessing = false;
let isPaused = false;
let processingInterval = null;
let sessionStartTime = new Date();

async function startCamera() {
    try {
        console.log('üìπ Requesting camera access...');

        // Request camera access
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            },
            audio: false
        });

        const videoElement = document.getElementById('videoElement');
        videoElement.srcObject = stream;

        // Wait for video to be ready
        await new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                resolve();
            };
        });

        console.log('‚úÖ Camera access granted and video playing');
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('statusIndicator').className = 'w-3 h-3 bg-green-500 rounded-full';
        document.getElementById('statusText').textContent = 'Camera Active';

        // Start processing frames
        startFrameProcessing();

    } catch (error) {
        console.error('‚ùå Camera access failed:', error);
        handleCameraError(error);
    }
}

function handleCameraError(error) {
    let errorMessage = 'Unable to access camera';
    let errorDetails = '';

    if (error.name === 'NotAllowedError') {
        errorMessage = 'Camera permission denied';
        errorDetails = 'Please allow camera access in your browser and try again.';
    } else if (error.name === 'NotFoundError') {
        errorMessage = 'No camera found';
        errorDetails = 'Please connect a camera and refresh the page.';
    } else if (error.name === 'NotReadableError') {
        errorMessage = 'Camera is busy';
        errorDetails = 'Camera may be in use by another application.';
    }

    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.innerHTML = `
        <div class="text-center text-white">
            <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-400"></i>
            <p class="font-semibold">${errorMessage}</p>
            <p class="text-sm mb-4">${errorDetails}</p>
            <div class="space-y-2">
                <button onclick="retryCamera()" class="block w-full bg-red-500 hover:bg-red-600 px-4 py-2 rounded">
                    <i class="fas fa-redo mr-2"></i>Retry Camera Access
                </button>
                <button onclick="goBack()" class="block w-full bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded">
                    <i class="fas fa-arrow-left mr-2"></i>Go Back
                </button>
            </div>
        </div>
    `;
    loadingOverlay.style.display = 'flex';
    document.getElementById('statusIndicator').className = 'w-3 h-3 bg-red-500 rounded-full';
    document.getElementById('statusText').textContent = 'Camera Error';
}

async function retryCamera() {
    console.log('üîÑ Retrying camera access...');
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.innerHTML = `
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="font-semibold">Requesting Camera Access...</p>
            <p class="text-sm">Please allow camera permissions when prompted.</p>
        </div>
    `;
    document.getElementById('statusText').textContent = 'Requesting Access...';
    document.getElementById('statusIndicator').className = 'w-3 h-3 bg-blue-500 rounded-full animate-pulse';

    // Stop any existing stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }

    // Try to start camera again
    await startCamera();
}

function startFrameProcessing() {
    const canvas = document.getElementById('canvasElement');
    const video = document.getElementById('videoElement');
    const ctx = canvas.getContext('2d');

    // Set canvas size to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Process frames every 3 seconds
    processingInterval = setInterval(async () => {
        if (isProcessing || isPaused) return;

        try {
            isProcessing = true;

            // Capture frame from video
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to blob and send to backend
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('frame', blob, 'frame.jpg');

                try {
                    const response = await fetch('/api/process_frame', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        handleDetectionResult(result);
                    }
                } catch (error) {
                    console.log('Frame processing failed:', error);
                } finally {
                    isProcessing = false;
                }
            }, 'image/jpeg', 0.8);

        } catch (error) {
            console.error('Frame processing error:', error);
            isProcessing = false;
        }
    }, 3000); // Process every 3 seconds
}

function handleDetectionResult(result) {
    if (result.success && result.detections) {
        // Update detection count
        const detectionCountEl = document.getElementById('detectionCount');
        if (detectionCountEl) {
            detectionCountEl.textContent = result.total_detections || 0;
        }

        // Update detection list
        updateDetectionList(result.detections);

        // Update status
        if (result.detections.length > 0) {
            document.getElementById('statusText').textContent = 'Camera Active - Detection Found';
        }
    }
}

function goBack() {
    window.location.href = "{% url 'detect_unauthorized' %}";
}

// Pause/Resume functionality
document.addEventListener('DOMContentLoaded', () => {
    startCamera();

    // Set up pause/resume buttons
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');

    pauseBtn.addEventListener('click', function() {
        isPaused = true;

        // Show pause overlay
        const pauseOverlay = document.createElement('div');
        pauseOverlay.id = 'pauseOverlay';
        pauseOverlay.className = 'absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center';
        pauseOverlay.innerHTML = `
            <div class="text-center text-white">
                <i class="fas fa-pause-circle text-6xl mb-4 text-yellow-400"></i>
                <p class="text-xl font-semibold">Camera Paused</p>
                <p class="text-sm">Detection is temporarily stopped</p>
            </div>
        `;
        document.getElementById('videoElement').parentElement.appendChild(pauseOverlay);

        pauseBtn.classList.add('hidden');
        resumeBtn.classList.remove('hidden');
        document.getElementById('statusIndicator').className = 'w-3 h-3 bg-yellow-500 rounded-full';
        document.getElementById('statusText').textContent = 'Paused';

        console.log('Camera paused - frame processing stopped');
    });

    resumeBtn.addEventListener('click', function() {
        isPaused = false;

        // Remove pause overlay
        const pauseOverlay = document.getElementById('pauseOverlay');
        if (pauseOverlay) {
            pauseOverlay.remove();
        }

        resumeBtn.classList.add('hidden');
        pauseBtn.classList.remove('hidden');
        document.getElementById('statusIndicator').className = 'w-3 h-3 bg-green-500 rounded-full';
        document.getElementById('statusText').textContent = 'Camera Active';

        console.log('Camera resumed - frame processing restarted');
    });

    // Update session duration
    setInterval(updateSessionDuration, 1000);

    // Check for real-time detection updates every 5 seconds
    const detectionInterval = setInterval(checkForDetections, 5000);
    window.detectionIntervalId = detectionInterval;
});

function updateSessionDuration() {
    const now = new Date();
    const duration = Math.floor((now - sessionStartTime) / 1000);
    const hours = Math.floor(duration / 3600);
    const minutes = Math.floor((duration % 3600) / 60);
    const seconds = duration % 60;

    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('sessionDuration').textContent = timeString;
}

function checkForDetections() {
    // Only check if camera is active and page is visible
    if (isPaused || document.visibilityState !== 'visible') {
        return;
    }

    // Show loading indicator
    const detectionList = document.getElementById('detectionList');
    if (detectionList && detectionList.children.length === 1 &&
        detectionList.children[0].textContent.includes('No detections yet')) {
        // Add loading indicator
        const loadingItem = document.createElement('div');
        loadingItem.id = 'loadingIndicator';
        loadingItem.className = 'text-center py-2 text-gray-500';
        loadingItem.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading detections...';
        detectionList.insertBefore(loadingItem, detectionList.firstChild);
    }

    // Fetch recent detections from the API with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout

    fetch('/api/recent_detections', {
        signal: controller.signal,
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Remove loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (data.success) {
            // Update detection count with animation
            const detectionCountEl = document.getElementById('detectionCount');
            if (detectionCountEl) {
                const currentCount = parseInt(detectionCountEl.textContent) || 0;
                const newCount = data.total_count;

                if (currentCount !== newCount) {
                    detectionCountEl.textContent = newCount;
                    detectionCountEl.classList.add('text-green-600', 'font-bold');
                    setTimeout(() => {
                        detectionCountEl.classList.remove('text-green-600', 'font-bold');
                    }, 2000);
                }
            }

            // Update detection list
            updateDetectionList(data.detections);

            // Update status if we have recent detections
            if (data.recent_count > 0) {
                const statusText = document.getElementById('statusText');
                if (statusText && statusText.textContent === 'Camera Active') {
                    statusText.textContent = 'Camera Active - Detections Found';
                }
            }

            console.log(`‚úÖ Detection check successful: ${data.recent_count} recent, ${data.total_count} total`);
        } else {
            throw new Error(data.error || 'Unknown API error');
        }
    })
    .catch(error => {
        // Remove loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (error.name === 'AbortError') {
            console.log('‚è∞ Detection check timed out');
        } else {
            console.log('‚ùå Detection check failed:', error.message);
        }
    });
}

function updateDetectionList(detections) {
    const detectionList = document.getElementById('detectionList');

    // Clear existing detections
    detectionList.innerHTML = '';

    if (detections.length === 0) {
        detectionList.innerHTML = `
            <div class="text-gray-500 text-center py-4">
                <i class="fas fa-search text-3xl mb-2"></i>
                <p>No recent detections...</p>
            </div>
        `;
        return;
    }

    // Add each detection
    detections.forEach(detection => {
        const detectionItem = document.createElement('div');
        detectionItem.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 ${
            detection.handled ? 'border-green-500' : 'border-red-500'
        }`;

        const confidenceColor = detection.confidence > 0.8 ? 'text-red-600' :
                               detection.confidence > 0.6 ? 'text-yellow-600' : 'text-gray-600';

        detectionItem.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-gray-800">${detection.name}</div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-clock mr-1"></i>${detection.timestamp}
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-map-marker-alt mr-1"></i>${detection.area}
                </div>
                <div class="text-xs text-gray-500">${detection.coordinates}</div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium ${confidenceColor}">
                    ${Math.round(detection.confidence * 100)}%
                </div>
                <div class="text-xs text-gray-500">confidence</div>
                ${detection.handled ? '<div class="text-xs text-green-600 font-medium">Handled</div>' : ''}
            </div>
        `;

        detectionList.appendChild(detectionItem);
    });
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('Page hidden - pausing detection checks');
    } else {
        console.log('Page visible - resuming detection checks');
    }
});

// Handle page unload - cleanup resources
window.addEventListener('beforeunload', function(event) {
    console.log('Page unloading - cleaning up resources...');

    // Clear intervals
    if (window.detectionIntervalId) {
        clearInterval(window.detectionIntervalId);
        console.log('Detection interval cleared');
    }

    // Stop camera stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        console.log('Camera stream stopped');
    }

    // Clear processing interval
    if (processingInterval) {
        clearInterval(processingInterval);
        console.log('Processing interval cleared');
    }
});

// Handle browser back/forward navigation
window.addEventListener('popstate', function() {
    console.log('Navigation detected - cleaning up...');
    cleanupResources();
});

// Cleanup function
function cleanupResources() {
    // Clear intervals
    if (window.detectionIntervalId) {
        clearInterval(window.detectionIntervalId);
        console.log('Detection interval cleared');
    }

    // Stop camera stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        console.log('Camera stream stopped');
    }

    // Clear processing interval
    if (processingInterval) {
        clearInterval(processingInterval);
        console.log('Processing interval cleared');
    }
}

// Add cleanup to stop button
document.addEventListener('DOMContentLoaded', function() {
    const stopBtn = document.querySelector('a[href*="stop_webcam"]');
    if (stopBtn) {
        stopBtn.addEventListener('click', function(event) {
            event.preventDefault();
            console.log('Stop button clicked - cleaning up...');

            // Show loading state
            const originalText = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
            stopBtn.classList.add('opacity-75', 'cursor-not-allowed');

            // Perform cleanup
            cleanupResources();

            // Navigate after a short delay
            setTimeout(() => {
                window.location.href = stopBtn.getAttribute('href');
            }, 1000);
        });
    }
});

function updateSessionDuration() {
    const now = new Date();
    const duration = Math.floor((now - sessionStartTime) / 1000);
    const hours = Math.floor(duration / 3600);
    const minutes = Math.floor((duration % 3600) / 60);
    const seconds = duration % 60;
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('sessionDuration').textContent = timeString;
}

function checkForDetections() {
    // Only check if camera is active and page is visible
    if (isPaused || document.visibilityState !== 'visible') {
        return;
    }

    // Show loading indicator
    const detectionList = document.getElementById('detectionList');
    if (detectionList && detectionList.children.length === 1 &&
        detectionList.children[0].textContent.includes('No detections yet')) {
        // Add loading indicator
        const loadingItem = document.createElement('div');
        loadingItem.id = 'loadingIndicator';
        loadingItem.className = 'text-center py-2 text-gray-500';
        loadingItem.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading detections...';
        detectionList.insertBefore(loadingItem, detectionList.firstChild);
    }

    // Fetch recent detections from the API with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout

    fetch('/api/recent_detections', {
        signal: controller.signal,
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Remove loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (data.success) {
            // Update detection count with animation
            const detectionCountEl = document.getElementById('detectionCount');
            if (detectionCountEl) {
                const currentCount = parseInt(detectionCountEl.textContent) || 0;
                const newCount = data.total_count;

                if (currentCount !== newCount) {
                    detectionCountEl.textContent = newCount;
                    detectionCountEl.classList.add('text-green-600', 'font-bold');
                    setTimeout(() => {
                        detectionCountEl.classList.remove('text-green-600', 'font-bold');
                    }, 2000);
                }
            }

            // Update detection list
            updateDetectionList(data.detections);

            // Update status if we have recent detections
            if (data.recent_count > 0) {
                const statusText = document.getElementById('statusText');
                if (statusText && statusText.textContent === 'Camera Active') {
                    statusText.textContent = 'Camera Active - Detections Found';
                }
            }

            console.log(`‚úÖ Detection check successful: ${data.recent_count} recent, ${data.total_count} total`);
        } else {
            throw new Error(data.error || 'Unknown API error');
        }
    })
    .catch(error => {
        // Remove loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (error.name === 'AbortError') {
            console.log('‚è∞ Detection check timed out');
        } else {
            console.log('‚ùå Detection check failed:', error.message);
        }

        // Don't show error to user, just log it
        // The polling will continue automatically
    });
}

function updateDetectionList(detections) {
    const detectionList = document.getElementById('detectionList');

    // Clear existing detections
    detectionList.innerHTML = '';

    if (detections.length === 0) {
        detectionList.innerHTML = `
            <div class="text-gray-500 text-center py-4">
                <i class="fas fa-search text-3xl mb-2"></i>
                <p>No recent detections...</p>
            </div>
        `;
        return;
    }

    // Add each detection
    detections.forEach(detection => {
        const detectionItem = document.createElement('div');
        detectionItem.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 ${
            detection.handled ? 'border-green-500' : 'border-red-500'
        }`;

        const confidenceColor = detection.confidence > 0.8 ? 'text-red-600' :
                               detection.confidence > 0.6 ? 'text-yellow-600' : 'text-gray-600';

        detectionItem.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-gray-800">${detection.name}</div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-clock mr-1"></i>${detection.timestamp}
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-map-marker-alt mr-1"></i>${detection.area}
                </div>
                <div class="text-xs text-gray-500">${detection.coordinates}</div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium ${confidenceColor}">
                    ${Math.round(detection.confidence * 100)}%
                </div>
                <div class="text-xs text-gray-500">confidence</div>
                ${detection.handled ? '<div class="text-xs text-green-600 font-medium">Handled</div>' : ''}
            </div>
        `;

        detectionList.appendChild(detectionItem);
    });
}

function addDetection(name, status, confidence, timestamp) {
    detectionCount++;
    document.getElementById('detectionCount').textContent = detectionCount;
    
    const detectionList = document.getElementById('detectionList');
    
    // Remove "no detections" message if it exists
    if (detectionList.querySelector('.text-gray-500')) {
        detectionList.innerHTML = '';
    }
    
    const detectionItem = document.createElement('div');
    detectionItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 border-red-500';
    detectionItem.innerHTML = `
        <div>
            <div class="font-semibold text-gray-800">${name}</div>
            <div class="text-sm text-gray-600">Status: ${status.toUpperCase()}</div>
            <div class="text-xs text-gray-500">${timestamp}</div>
        </div>
        <div class="text-right">
            <div class="text-sm font-medium ${confidence > 0.8 ? 'text-red-600' : 'text-yellow-600'}">
                ${Math.round(confidence * 100)}%
            </div>
            <div class="text-xs text-gray-500">confidence</div>
        </div>
    `;
    
    detectionList.insertBefore(detectionItem, detectionList.firstChild);
    
    // Keep only the last 10 detections
    while (detectionList.children.length > 10) {
        detectionList.removeChild(detectionList.lastChild);
    }
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Pause polling when tab is not visible to save resources
        console.log('Page hidden - pausing detection checks');
    } else {
        // Resume when tab becomes visible
        console.log('Page visible - resuming detection checks');
    }
});

// Handle page unload - cleanup resources
window.addEventListener('beforeunload', function(event) {
    console.log('Page unloading - cleaning up resources...');

    // Clear intervals
    if (window.detectionIntervalId) {
        clearInterval(window.detectionIntervalId);
        console.log('Detection interval cleared');
    }

    // Stop camera if active - use synchronous request for better reliability
    if (typeof camera_active !== 'undefined' && camera_active) {
        // Show leaving message
        const confirmationMessage = 'Camera session is active. Leaving this page will stop the camera. Continue?';
        event.returnValue = confirmationMessage; // Standard for most browsers
        return confirmationMessage; // For some older browsers

        // Note: The actual cleanup will happen via the stop button or manual navigation
    }
});

// Handle browser back/forward navigation
window.addEventListener('popstate', function() {
    console.log('Navigation detected - cleaning up...');
    cleanupResources();
});

// Cleanup function
function cleanupResources() {
    // Clear intervals
    if (window.detectionIntervalId) {
        clearInterval(window.detectionIntervalId);
        console.log('Detection interval cleared');
    }

    // Stop camera if active
    if (typeof camera_active !== 'undefined' && camera_active) {
        console.log('Stopping camera session...');
        // Use fetch with keepalive to ensure request completes
        fetch('/stop_webcam', {
            method: 'GET',
            keepalive: true,
            headers: {
                'Cache-Control': 'no-cache'
            }
        }).then(() => {
            console.log('Camera stopped successfully');
        }).catch(error => {
            console.log('Cleanup request failed:', error);
        });
    }
}

// Add cleanup to stop button
document.addEventListener('DOMContentLoaded', function() {
    const stopBtn = document.querySelector('a[href*="stop_webcam"]');
    if (stopBtn) {
        stopBtn.addEventListener('click', function(event) {
            event.preventDefault();
            console.log('Stop button clicked - cleaning up...');

            // Show loading state
            const originalText = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
            stopBtn.classList.add('opacity-75', 'cursor-not-allowed');

            // Perform cleanup
            cleanupResources();

            // Navigate after a short delay
            setTimeout(() => {
                window.location.href = stopBtn.getAttribute('href');
            }, 1000);
        });
    }
});
</script>
{% endblock %}